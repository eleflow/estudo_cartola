-- Cartola

-- API de futebol
-- https://www.api-football.com/documentation-v3#section/Introduction
-- https://rapidapi.com/api-sports/api/api-football
-- https://www.sportmonks.com/football-api/#plans-pricing


-- Schema

create table country(
ID serial PRIMARY KEY, 
NAME varchar(200),
CODE char(2),
FLAG varchar(200),
TIMEZONE varchar(10)
);
comment on column country.FLAG is 'URL';
comment on column country.TIMEZONE is 'Manually set. e.g. UTC+1 / UTC+6 / UTC-2 / UTC';
CREATE UNIQUE INDEX country_ix_un ON country (NAME);


create table league(
ID INTEGER primary key,
NAME VARCHAR(150),
TYPE VARCHAR(100),
LOGO VARCHAR(200),
ID_COUNTRY INTEGER,
   CONSTRAINT fk_country
      FOREIGN KEY(ID_COUNTRY) 
	  REFERENCES country(id)
	  ON DELETE NO ACTION
);
comment on column league.LOGO is 'URL';

create table round( 
ID_LEAGUE INTEGER,
SEASON INTEGER,
NAME VARCHAR(200),
primary key (ID_LEAGUE, SEASON, NAME),
ID_COUNTRY INTEGER,
CONSTRAINT fk_LEAGUE
      FOREIGN KEY(ID_LEAGUE) 
	  REFERENCES league(ID)
	  ON DELETE NO ACTION
)

comment on TABLE round is 'If league is a cup, check weekly for new rounds';

CREATE TABLE referee (
	id serial4 NOT NULL,
	"name" varchar(150) NULL,
	CONSTRAINT referee_pkey PRIMARY KEY (id)
);
CREATE UNIQUE INDEX referee_name_idx ON referee ("name");

create table stadium(
	ID INTEGER primary key,  
	NAME VARCHAR(150),
	ADRESS VARCHAR(1000),
	CAPACITY INT,
	SURFACE VARCHAR(250),
	IMAGE VARCHAR(200)
);

comment on column stadium.IMAGE is 'URL';

CREATE TABLE status (
	id serial4 NOT NULL,
	long_status varchar(50) NULL,
	short_status varchar(10) NULL,
	CONSTRAINT status_pkey PRIMARY KEY (id)
);
CREATE UNIQUE INDEX status_long_status_idx ON status USING btree (long_status, short_status);


create table team(
ID INTEGER PRIMARY KEY,
NAME VARCHAR(200),
ID_COUNTRY INTEGER,
YEAR_FOUNDED SMALLINT,
national BOOL,
LOGO VARCHAR(250),
ID_STADIUM INTEGER,
   CONSTRAINT fk_country
      FOREIGN KEY(ID_COUNTRY) 
	  REFERENCES country(id)
	  ON DELETE NO action,
   CONSTRAINT fk_stadium
      FOREIGN KEY(ID_STADIUM) 
	  REFERENCES stadium(id)
	  ON DELETE NO ACTION
);
comment on column team.national is 'Brazil, EUA, Spain, Italy...';
comment on column team.LOGO is 'URL';


create table city(
ID SERIAL,
NAME VARCHAR(150),
STATE VARCHAR(150),
ID_COUNTRY INTEGER,
primary key(ID),
   CONSTRAINT fk_country
      FOREIGN KEY(ID_COUNTRY) 
	  REFERENCES country(id)	  
	  ON DELETE NO ACTION
);

CREATE UNIQUE INDEX city_ix_un ON city (ID_COUNTRY, STATE, NAME);


CREATE TABLE fixture (
	id int4 NOT NULL,
	id_league int4 NULL,
	season integer null,
	id_referee int4 NULL,
	id_stadium int4 NULL,
	schedule_timestamp timestamp NULL,
	first_period_start_timestamp timestamp NULL,
	second_period_start_timestamp timestamp NULL,
	id_status int4 NULL,
	id_home_team int4 NULL,
	home_winner bool NULL,
	home_goals int2 NULL,
	id_away_team int4 NULL,
	away_winner bool NULL,
	away_goals int2 NULL,
	ht_home_goals int2 NULL,
	ht_away_goals int2 NULL,
	ft_home_goals int2 NULL,
	ft_away_goals int2 NULL,
	et_home_goals int2 NULL,
	et_away_goals int2 NULL,
	penalty_home int2 NULL,
	penalty_away int2 NULL,
	CONSTRAINT fixture_pkey PRIMARY KEY (id)
);


-- fixture foreign keys

ALTER TABLE fixture ADD CONSTRAINT fk_away_team FOREIGN KEY (id_away_team) REFERENCES team(id);
ALTER TABLE fixture ADD CONSTRAINT fk_home_team FOREIGN KEY (id_home_team) REFERENCES team(id);
ALTER TABLE fixture ADD CONSTRAINT fk_league FOREIGN KEY (id_league) REFERENCES league(id);
ALTER TABLE fixture ADD CONSTRAINT fk_referee FOREIGN KEY (id_referee) REFERENCES referee(id);
ALTER TABLE fixture ADD CONSTRAINT fk_stadium FOREIGN KEY (id_stadium) REFERENCES stadium(id);
ALTER TABLE fixture ADD CONSTRAINT fk_status FOREIGN KEY (id_status) REFERENCES status(id);

create table player(
id int4,
name varchar(100),
firstname varchar(100),
lastname varchar(100),
birth_date date,
id_country int4,
id_nationality  int4,
height decimal,
weight decimal,
injured bool default false,
photo varchar(200));

CREATE UNIQUE INDEX player_id_idx ON public.player (id);

ALTER TABLE player ADD CONSTRAINT fk_id_country FOREIGN KEY (id_country) REFERENCES country(id);
ALTER TABLE player ADD CONSTRAINT fk_id_nationality FOREIGN KEY (id_nationality) REFERENCES country(id);


create table player_league_statistics(
id_player int4,
id_team int4,
id_league int4,
season int4,
game_appearences int4,
game_lineups int4,
game_minutes int4,
game_number  int4,
game_position varchar(100),
game_rating float,
game_captain bool,
substitutes_in  int4,
substitutes_out  int4,
substitutes_bench  int4,
shots_total  int4,
shots_on  int4,
goals_total  int4,
goals_conceded  int4,
goals_assists  int4,
goals_saves  int4,
passes_total  int4,
passes_key  int4,
passes_accuracy  int4,
tackles_total  int4,
tackles_blocks  int4,
tackles_interceptions  int4,
duels_total  int4,
duels_won  int4,
dribbles_attempts  int4,
dribbles_success  int4,
dribbles_past  int4,
fouls_drawn  int4,
fouls_committed  int4,
cards_yellow  int4,
cards_yellowred  int4,
cards_red  int4,
penalty_won  int4,
penalty_commited  int4,
penalty_scored  int4,
penalty_missed  int4,
penalty_saved  int4
);

ALTER TABLE player_league_statistics ADD CONSTRAINT fk_id_player FOREIGN KEY (id_player) REFERENCES player(id);
ALTER TABLE player_league_statistics ADD CONSTRAINT fk_id_team FOREIGN KEY (id_team) REFERENCES team(id);
ALTER TABLE player_league_statistics ADD CONSTRAINT fk_id_league FOREIGN KEY (id_league) REFERENCES league(id);

INSERT INTO status (short_status, long_status) VALUES('TBD','Time To Be Defined');
INSERT INTO status (short_status, long_status) VALUES('NS','Not Started');
INSERT INTO status (short_status, long_status) VALUES('1H','First Half, Kick Off');
INSERT INTO status (short_status, long_status) VALUES('HT','Halftime');
INSERT INTO status (short_status, long_status) VALUES('2H','Second Half, 2nd Half Started');
INSERT INTO status (short_status, long_status) VALUES('ET','Extra Time');
INSERT INTO status (short_status, long_status) VALUES('FT','Match Finished');
INSERT INTO status (short_status, long_status) VALUES('AET','Match Finished After Extra Time');
INSERT INTO status (short_status, long_status) VALUES('PEN','Match Finished After Penalty');
INSERT INTO status (short_status, long_status) VALUES('BT','Break Time (in Extra Time)');
INSERT INTO status (short_status, long_status) VALUES('SUSP','Match Suspended');
INSERT INTO status (short_status, long_status) VALUES('INT','Match Interrupted');
INSERT INTO status (short_status, long_status) VALUES('PST','Match Postponed');
INSERT INTO status (short_status, long_status) VALUES('CANC','Match Cancelled');
INSERT INTO status (short_status, long_status) VALUES('ABD','Match Abandoned');
INSERT INTO status (short_status, long_status) VALUES('AWD','Technical Loss');
INSERT INTO status (short_status, long_status) VALUES('WO','WalkOver');
INSERT INTO status (short_status, long_status) VALUES('LIVE','In Progress');


INSERT INTO public.country (id, "name", code) VALUES(0, 'Error', 'ER');
